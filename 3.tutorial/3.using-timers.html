<!DOCTYPE html> <html lang="en" dir="auto"> <head><meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=no"> <meta name="description" content="Using timers The previous step show how enable the pump whenever the moisture level reaches a certain threshold. Sensor data often fluctuates which..."> <meta name="revised" content="915f8f35814363076ca83950ca026e860c5ef2da"> <meta name="author" content="iothingy"> <meta name="generator" content="rundocs/jekyll-rtd-theme v2.0.10"><meta name="theme-color" content="#2980b9"> <title>Using timers 路 IoThingy</title> <meta name="twitter:title" content="Using timers 路 IoThingy"> <meta name="twitter:description" content="Using timers The previous step show how enable the pump whenever the moisture level reaches a certain threshold. Sensor data often fluctuates which..."> <meta name="twitter:card" content="summary"> <meta name="twitter:site" content="@iothingy"> <meta name="twitter:url" content="https://iothingy.io//pages/iothingy/website/3.tutorial/3.using-timers.html"> <meta name="twitter:creator" content="@rundocs/jekyll-rtd-theme v2.0.10"> <meta property="og:title" content="Using timers 路 IoThingy"> <meta property="og:description" content="Using timers The previous step show how enable the pump whenever the moisture level reaches a certain threshold. Sensor data often fluctuates which..."> <meta property="og:locale" content="en"> <meta property="og:url" content="https://iothingy.io//pages/iothingy/website/3.tutorial/3.using-timers.html"> <meta property="og:type" content="article"> <meta property="article:author" content="iothingy"> <meta property="article:published_time" content="2021-02-25T02:48:04+00:00"> <meta property="article:modified_time" content="2021-02-25T02:48:04+00:00"> <script type="application/ld+json"> { "@context": "https://schema.org", "@type": "Article", "mainEntityOfPage": { "@type": "WebPage", "@id": "https://iothingy.io//pages/iothingy/website/3.tutorial/3.using-timers.html" }, "headline": "Using timers 路 IoThingy", "image": [], "author": { "@type": "Person", "name": "iothingy" }, "datePublished": "2021-02-25T02:48:04+00:00", "dateModified": "2021-02-25T02:48:04+00:00", "publisher": { "@type": "Organization", "name": "iothingy", "logo": { "@type": "ImageObject", "url": "https://avatars.githubusercontent.com/u/78229720?v=4" } }, "description": "Using timers The previous step show how enable the pump whenever the moisture level reaches a certain threshold. Sensor data often fluctuates which..." } </script> <link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="prev" href="https://iothingy.io//pages/iothingy/website/3.tutorial/2.controlling-actuators.html"><link rel="next" href="https://iothingy.io//pages/iothingy/website/3.tutorial/1.reading-sensors.html"><link rel="canonical" href="https://iothingy.io//pages/iothingy/website/3.tutorial/3.using-timers.html"><link rel="icon" type="image/svg+xml" href="/pages/iothingy/website/assets/images/favicon.svg"><link rel="icon" type="image/png" href="/pages/iothingy/website/assets/images/favicon-16x16.png" sizes="16x16"> <link rel="icon" type="image/png" href="/pages/iothingy/website/assets/images/favicon-32x32.png" sizes="32x32"> <link rel="icon" type="image/png" href="/pages/iothingy/website/assets/images/favicon-96x96.png" sizes="96x96"><link rel="mask-icon" href="/pages/iothingy/website/assets/images/favicon.svg" color="#2980b9"><link rel="apple-touch-icon" href="/pages/iothingy/website/assets/images/apple-touch-icon-300x300.jpg"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rundocs/jekyll-rtd-theme@2.0.10/assets/css/theme.min.css"><script> window.ui = { title: "IoThingy", baseurl: "/pages/iothingy/website", i18n: { search_results: "Search Results", search_results_found: "Search finished, found # page(s) matching the search query.", search_results_not_found: "Your search did not match any documents, please make sure that all characters are spelled correctly!" } }; </script> </head> <body class="container"><div class="sidebar-wrap overflow-hidden"> <div class="sidebar height-full overflow-y-scroll overflow-x-hidden"> <div class="header d-flex flex-column p-3 text-center"> <div class="title pb-1"> <a class="h4 no-underline py-1 px-2 rounded-1" href="/pages/iothingy/website/" title="Core library for writing your own IoThingies by implementing your custom peripherals and/or using existing ones from other projects. It uses MQTT to send metrics of each peripheral and/or receive commands to change state."> <i class="fa fa-home"></i> IoThingy </a> </div> <span class="version"></span> <form class="search pt-2" action="/pages/iothingy/website/search.html" method="get" autocomplete="off"> <input class="form-control input-block input-sm" type="text" name="q" placeholder="Search docs..."> </form> </div> <div class="toctree py-2" data-spy="affix" role="navigation" aria-label="main navigation"> <ul> </ul> <a class="caption d-block text-uppercase no-wrap px-2 py-0" href="/pages/iothingy/website/1.getting-started/"> Getting started </a><ul> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/pages/iothingy/website/1.getting-started/1.install.html">Installation</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/pages/iothingy/website/1.getting-started/2-code.html">Code</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/pages/iothingy/website/1.getting-started/3-settings.html">Settings</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/pages/iothingy/website/1.getting-started/4.upload.html">Upload</a> </li></ul> <a class="caption d-block text-uppercase no-wrap px-2 py-0" href="/pages/iothingy/website/2.documentation/"> Documentation </a><ul> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/pages/iothingy/website/2.documentation/1.process-flow.html">Process flow</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/pages/iothingy/website/2.documentation/2.platforms.html">Platforms</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/pages/iothingy/website/2.documentation/3.memory-usage.html">Memory usage</a> </li></ul> <a class="caption d-block text-uppercase no-wrap px-2 py-0" href="/pages/iothingy/website/4.resources/"> Resources </a><ul> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/pages/iothingy/website/4.resources/peripherals.html">Peripherals</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/pages/iothingy/website/4.resources/projects.html">Projects</a> </li></ul> <a class="caption d-block text-uppercase no-wrap px-2 py-0" href="/pages/iothingy/website/3.tutorial/"> Tutorial </a><ul> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/pages/iothingy/website/3.tutorial/2.controlling-actuators.html">Controlling actuators</a> </li> <li class="toc level-1 current" data-sort="" data-level="1"> <a class="d-flex flex-items-baseline current" href="/pages/iothingy/website/3.tutorial/3.using-timers.html">Using timers</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/pages/iothingy/website/3.tutorial/1.reading-sensors.html">Reading sensors</a> </li></ul> </div> </div> </div> <div class="content-wrap"> <div class="header d-flex flex-justify-between p-2 hide-lg hide-xl" aria-label="top navigation"> <button id="toggle" aria-label="Toggle menu" class="btn-octicon p-2 m-0 text-white" type="button"> <i class="fa fa-bars"></i> </button> <div class="title flex-1 d-flex flex-justify-center"> <a class="h4 no-underline py-1 px-2 rounded-1" href="/pages/iothingy/website/">IoThingy</a> </div> </div> <div class="content p-3 p-sm-5"> <div class="navigation-top d-flex flex-justify-between"> <ul class="breadcrumb" role="navigation" aria-label="breadcrumbs navigation"> <li class="breadcrumb-item"> <a class="no-underline" href="/pages/iothingy/website/" title="/"> <i class="fa fa-home"></i> </a> </li><li class="breadcrumb-item" ><a href="/pages/iothingy/website/3.tutorial/">3.tutorial</a></li><li class="breadcrumb-item" aria-current="page">3.using-timers.md</li></ul> <a class="edit" href="https://github.com/iothingy/website/edit/gh-pages/3.tutorial/3.using-timers.md" title="Edit on GitHub" rel="noreferrer" target="_blank"> <i class="fa fa-edit"></i> </a> </div> <hr> <div role="main" itemscope="itemscope" itemtype="https://schema.org/Article"> <div class="markdown-body" itemprop="articleBody"> <h1 id="using-timers">Using timers</h1> <p>The previous step show how enable the pump whenever the moisture level reaches a certain threshold. Sensor data often fluctuates which can cause the pump to start/stop a lot of times within a short period and/or keep watering the plant until the sensor value is below the threshold. To prevent timers will be used to make sure that once it receives a trigger to water the plants it will enable the pump for a certain amount after which it will also be disabled for a certain amount.</p> <h2 id="constructor">Constructor</h2> <p>Another constructor will be added to set the time how long to enable the pump. A default value will be set for when the argument is not passed in the constructor.</p> <div class="language-c highlighter-rouge notranslate"><div class="highlight"><pre class="highlight"><code>
<span class="cp">#define PLANT_MOISTURE_THRESHOLD 567             // Analog reading between 0 and 1023
#define PLANT_PUMP_DURATION      3               // Time (ms/100K) = 3sec
</span>
<span class="kt">void</span> <span class="nf">plant_set_defaults</span><span class="p">(</span> <span class="kt">uint8_t</span> <span class="n">slot</span> <span class="p">)</span> <span class="p">{</span> 
  <span class="c1">// Reset timers</span>
  <span class="n">peripherals</span><span class="p">[</span> <span class="n">slot</span> <span class="p">].</span><span class="n">timer01</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
  <span class="n">peripherals</span><span class="p">[</span> <span class="n">slot</span> <span class="p">].</span><span class="n">timer02</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>

  <span class="c1">// Plant specific: Moisture threshold &amp; pump duration</span>
  <span class="n">peripherals</span><span class="p">[</span> <span class="n">slot</span> <span class="p">].</span><span class="n">val01</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">PLANT_MOISTURE_THRESHOLD</span><span class="p">;</span>
  <span class="n">peripherals</span><span class="p">[</span> <span class="n">slot</span> <span class="p">].</span><span class="n">val02</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">PLANT_PUMP_DURATION</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">plant_set_duration</span><span class="p">(</span> <span class="kt">uint8_t</span> <span class="n">slot</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">duration</span> <span class="p">)</span> <span class="p">{</span>
  <span class="n">SERIAL_DEBUG_S</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">"- duration: "</span><span class="p">));</span>
  <span class="n">SERIAL_DEBUG_I</span><span class="p">(</span><span class="n">duration</span><span class="p">);</span>
  <span class="n">SERIAL_DEBUG_S</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">));</span>
  <span class="n">peripherals</span><span class="p">[</span> <span class="n">slot</span> <span class="p">].</span><span class="n">val02</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">duration</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**
 * Instantiate a plant peripheral with an analog input pin to measure the
 * moisture level, digital output pin to control a pump, threshold and
 * duration.
 */</span>
<span class="kt">int8_t</span> <span class="nf">plant</span><span class="p">(</span> <span class="kt">char</span> <span class="n">name</span><span class="p">[],</span> <span class="kt">uint8_t</span> <span class="n">moisture_pin</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">pump_pin</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">threshold</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">duration</span> <span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Get free peripheral slot</span>
  <span class="kt">int8_t</span> <span class="n">slot</span> <span class="o">=</span> <span class="n">peripheral_register</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">TYPE_PLANT</span> <span class="p">);</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">plant_set_defaults</span><span class="p">(</span> <span class="n">slot</span> <span class="p">);</span>
  <span class="n">plant_set_moisture_pin</span><span class="p">(</span> <span class="n">slot</span><span class="p">,</span> <span class="n">moisture_pin</span> <span class="p">);</span>
  <span class="n">plant_set_pump_pin</span><span class="p">(</span> <span class="n">slot</span><span class="p">,</span> <span class="n">pump_pin</span> <span class="p">);</span>
  <span class="n">plant_set_threshold</span><span class="p">(</span> <span class="n">slot</span><span class="p">,</span> <span class="n">threshold</span> <span class="p">);</span>
  <span class="n">plant_set_duration</span><span class="p">(</span> <span class="n">slot</span><span class="p">,</span> <span class="n">duration</span> <span class="p">);</span>
  <span class="n">serial_display_memory_usage</span><span class="p">();</span>

  <span class="k">return</span> <span class="n">slot</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>  </div></div> <h2 id="setting-output-pins">Setting output pins</h2> <p>The logic for controlling the output pins need to be changed to deal with the various timers. Once the threshold has been reached the first timer will be set to the current time. Next iteration this timer will be compared to the duration. After the specified duration has passed another timer will be set to cool down the pump to prevent over watering the plant. In this example the duration of the cooldown period is hard coded, but could be moved to a constant or peripheral argument.</p> <div class="language-c highlighter-rouge notranslate"><div class="highlight"><pre class="highlight"><code>
<span class="cm">/**
 * Output the stored value to the output pin(s) with the specified mode(s).
 */</span>
<span class="kt">void</span> <span class="nf">plant_set_output_pins</span><span class="p">(</span> <span class="kt">uint8_t</span> <span class="n">slot</span> <span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">COOLDOWN</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>

  <span class="n">bool</span> <span class="n">thresholdReached</span>   <span class="o">=</span> <span class="n">peripherals</span><span class="p">[</span> <span class="n">slot</span> <span class="p">].</span><span class="n">val03</span><span class="p">.</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">peripherals</span><span class="p">[</span> <span class="n">slot</span> <span class="p">].</span><span class="n">val01</span><span class="p">.</span><span class="n">i</span><span class="p">;</span>
  <span class="n">bool</span> <span class="n">pumpHasStarted</span>     <span class="o">=</span> <span class="n">millis</span><span class="p">()</span> <span class="o">-</span> <span class="n">peripherals</span><span class="p">[</span> <span class="n">slot</span> <span class="p">].</span><span class="n">timer01</span> <span class="o">&lt;=</span> <span class="n">peripherals</span><span class="p">[</span> <span class="n">slot</span> <span class="p">].</span><span class="n">val02</span><span class="p">.</span><span class="n">i</span><span class="p">;</span>
  <span class="n">bool</span> <span class="n">inCooldownPeriod</span>   <span class="o">=</span> <span class="n">millis</span><span class="p">()</span> <span class="o">-</span> <span class="n">peripherals</span><span class="p">[</span> <span class="n">slot</span> <span class="p">].</span><span class="n">timer02</span> <span class="o">&lt;=</span> <span class="n">COOLDOWN</span><span class="p">;</span>
  <span class="n">bool</span> <span class="n">setPumpOn</span>          <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">inCooldownPeriod</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">SERIAL_DEBUG_S</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">"- cool down period =&gt; disable pump</span><span class="se">\n</span><span class="s">"</span><span class="p">));</span>

  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">pumpHasStarted</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">SERIAL_DEBUG_S</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">"- keep button on =&gt; enable pump</span><span class="se">\n</span><span class="s">"</span><span class="p">));</span>
    <span class="n">setPumpOn</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">peripherals</span><span class="p">[</span> <span class="n">slot</span> <span class="p">].</span><span class="n">timer02</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>

  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">thresholdReached</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">setPumpOn</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">SERIAL_DEBUG_S</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">"- threshold reached =&gt; enable pump</span><span class="se">\n</span><span class="s">"</span><span class="p">));</span>
    <span class="n">peripherals</span><span class="p">[</span> <span class="n">slot</span> <span class="p">].</span><span class="n">timer01</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>

  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// Default off</span>
    <span class="n">setPumpOn</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Set relay to pump on/off state.</span>
  <span class="n">SERIAL_DEBUG_S</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">"- setting pump relay to: "</span><span class="p">));</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">setPumpOn</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">SERIAL_DEBUG_S</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">"HIGH</span><span class="se">\n</span><span class="s">"</span><span class="p">));</span>
    <span class="n">digitalWrite</span><span class="p">(</span> <span class="n">peripherals</span><span class="p">[</span> <span class="n">slot</span> <span class="p">].</span><span class="n">pin05</span><span class="p">,</span> <span class="n">HIGH</span> <span class="p">);</span>
    <span class="n">digitalWrite</span><span class="p">(</span> <span class="n">peripherals</span><span class="p">[</span> <span class="n">slot</span> <span class="p">].</span><span class="n">pin02</span><span class="p">,</span> <span class="n">HIGH</span> <span class="p">);</span>

  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">SERIAL_DEBUG_S</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">"LOW</span><span class="se">\n</span><span class="s">"</span><span class="p">));</span>
    <span class="n">digitalWrite</span><span class="p">(</span> <span class="n">peripherals</span><span class="p">[</span> <span class="n">slot</span> <span class="p">].</span><span class="n">pin05</span><span class="p">,</span> <span class="n">LOW</span> <span class="p">);</span>
    <span class="n">digitalWrite</span><span class="p">(</span> <span class="n">peripherals</span><span class="p">[</span> <span class="n">slot</span> <span class="p">].</span><span class="n">pin02</span><span class="p">,</span> <span class="n">LOW</span> <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>  </div></div> </div> </div> <div class="navigation-bottom d-flex flex-justify-between py-3" role="navigation" aria-label="footer navigation"> <div class="prev"><a href="/pages/iothingy/website/3.tutorial/2.controlling-actuators.html" class="btn" title="Controlling actuators" accesskey="p" rel="prev"> <i class="fa fa-arrow-circle-left"></i> Previous </a></div> <div class="next"><a href="/pages/iothingy/website/3.tutorial/1.reading-sensors.html" class="btn" title="Reading sensors" accesskey="n" rel="next"> Next <i class="fa fa-arrow-circle-right"></i> </a></div> </div><hr> <div class="copyright text-center text-gray" role="contentinfo"> <i class="fa fa-copyright"></i> <span class="time">2021,</span> <a class="text-gray" href="https://github.com/iothingy" rel="noreferrer" target="_blank">iothingy</a> Revision <a class="text-gray" href="https://github.com/iothingy/website/commit/915f8f35814363076ca83950ca026e860c5ef2da" title="915f8f35814363076ca83950ca026e860c5ef2da" rel="noreferrer" target="_blank">915f8f3</a> <br> <div class="generator"> Built with <a href="https://pages.github.com" rel="noreferrer" target="_blank" title="github-pages v209">GitHub Pages</a> using a <a href="https://github.com/rundocs/jekyll-rtd-theme" rel="noreferrer" target="_blank" title="rundocs/jekyll-rtd-theme v2.0.10">theme</a> provided by <a href="https://rundocs.io" rel="noreferrer" target="_blank">RunDocs</a>. </div> </div> </div> </div> <div class="addons-wrap d-flex flex-column overflow-y-auto"> <div class="status d-flex flex-justify-between p-2"> <div class="title p-1"> <i class="fa fa-book"></i> IoThingy </div> <div class="branch p-1"> <span class="name"> gh-pages </span> <i class="fa fa-caret-down"></i> </div> </div> <div class="addons d-flex flex-column height-full p-2 d-none"> <dl> <dt>GitHub</dt> <dd> <a href="https://github.com/iothingy/website" title="Stars: "> <i class="fa fa-github"></i> Homepage </a> </dd> <dd> <a href="https://github.com/iothingy/website/issues" title="Open issues: "> <i class="fa fa-question-circle-o"></i> Issues </a> </dd> <dd> <a href="https://github.com/iothingy/website/zipball/gh-pages" title="Size: Kb"> <i class="fa fa-download"></i> Download </a> </dd> </dl> <hr> <div class="license f6 pb-2"> This <a href="/pages/iothingy/website/" title="IoThingy">Software</a> is under the terms of <a href="https://github.com/iothingy/website">The Unlicense</a>. </div> </div> </div> <script src="https://cdn.jsdelivr.net/gh/rundocs/jekyll-rtd-theme@2.0.10/assets/js/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/gh/rundocs/jekyll-rtd-theme@2.0.10/assets/js/theme.min.js"></script> </body> </html>